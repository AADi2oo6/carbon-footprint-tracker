<!-- templates/tracker/home.html -->
{% extends "tracker/base.html" %}
{% block content %}
<!-- Chart.js library for creating interactive charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    .stat-card {
        background-color: #ffffff;
        border: none;
        border-radius: 0.75rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        transition: transform 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-5px);
    }
    .stat-card .card-body {
        display: flex;
        align-items: center;
    }
    .stat-card .icon {
        font-size: 2.5rem;
        padding: 1.5rem;
        border-radius: 50%;
        color: white;
    }
    .stat-card .bg-success-light { background-color: rgba(40, 167, 69, 0.2); color: #28a745; }
    .stat-card .bg-info-light { background-color: rgba(23, 162, 184, 0.2); color: #17a2b8; }

    .chart-container {
        position: relative;
        height: 350px;
        width: 100%;
    }
    .progress {
        height: 1.5rem;
        border-radius: 0.75rem;
        font-size: 0.85rem;
        font-weight: 600;
    }
    .list-group-item {
        border-left: 4px solid transparent;
    }
    .list-group-item-action:hover {
        border-left-color: #28a745;
    }
    .achievement-icon {
        font-size: 1.5rem;
        color: #ffc107;
    }
    /* Styles for the streak calendar */
    .streak-container {
        display: flex;
        flex-direction: column;
    }
    .streak-grid {
        display: grid;
        grid-template-rows: repeat(7, 1fr); /* 7 days a week */
        grid-auto-flow: column;
        gap: 4px;
        margin-bottom: 5px;
    }
    .streak-day {
        width: 100%;
        aspect-ratio: 1 / 1;
        background-color: #ebedf0;
        border-radius: 3px;
    }
    .streak-day.active {
        background-color: #28a745;
    }
    .streak-months {
        display: flex;
        font-size: 0.75rem;
        color: #6c757d;
    }
    .streak-months div {
        text-align: center;
    }
    .streak-stats {
        font-size: 0.9rem;
        color: #495057;
    }
</style>

<!-- Page Header -->
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Your Dashboard</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group mr-2">
            <button type="button" class="btn btn-sm btn-outline-success">Share</button>
            <button type="button" class="btn btn-sm btn-outline-success">Export</button>
        </div>
        <button type="button" class="btn btn-sm btn-success">
            <i class="fas fa-plus-circle"></i> Log New Activity
        </button>
    </div>
</div>

<!-- Top Row: High-Level Stats -->
<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="icon bg-success-light mr-3"><i class="fas fa-tree"></i></div>
                <div>
                    <h5 class="card-title mb-1">Monthly Footprint</h5>
                    <p class="card-text h3 font-weight-bold">{{ total_footprint_this_month }} kg CO₂e</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="icon bg-info-light mr-3"><i class="fas fa-users"></i></div>
                <div>
                    <h5 class="card-title mb-1">Registered Users</h5>
                    <p class="card-text h3 font-weight-bold">{{ total_users }}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Row: Charts and Insights -->
<div class="row">
    <!-- Left Column: Main Charts -->
    <div class="col-lg-8">
        <!-- Trends Over Time Chart -->
        <div class="card stat-card mb-4">
            <div class="card-body">
                <h5 class="card-title">Footprint Trend (Last 6 Months)</h5>
                <div class="chart-container">
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Activity Streak Card -->
        <div class="card stat-card mb-4">
            <div class="card-body flex-column align-items-start">
                <h5 class="card-title">Activity Streak</h5>
                <p class="streak-stats w-100">
                    <strong>Total Active Days:</strong> <span id="total-active-days"></span> | 
                    <strong>Max Streak:</strong> <span id="max-streak"></span>
                </p>
                <div class="streak-container w-100">
                    <div class="streak-grid" id="streak-grid"></div>
                    <div class="streak-months" id="streak-months"></div>
                </div>
            </div>
        </div>

        <!-- Category Breakdown Chart -->
        <div class="card stat-card mb-4">
            <div class="card-body">
                <h5 class="card-title">Breakdown by Category</h5>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: Budget, Insights, Gamification -->
    <div class="col-lg-4">
        <!-- Carbon Budget Card -->
        <div class="card stat-card mb-4">
            <div class="card-body flex-column">
                <h5 class="card-title w-100">Monthly Carbon Budget</h5>
                <p>You have used <strong>{{ carbon_budget.used }} kg</strong> of your <strong>{{ carbon_budget.limit }} kg</strong> allowance.</p>
                <div class="progress w-100">
                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ carbon_budget.percentage }}%;" aria-valuenow="{{ carbon_budget.percentage }}" aria-valuemin="0" aria-valuemax="100">{{ carbon_budget.percentage }}%</div>
                </div>
            </div>
        </div>

        <!-- Actionable Insights Card -->
        <div class="card stat-card mb-4">
            <div class="card-body flex-column">
                <h5 class="card-title w-100 mb-3"><i class="fas fa-rocket text-success"></i> Actionable Insights</h5>
                <div class="list-group list-group-flush w-100">
                    {% for insight in actionable_insights %}
                        <a href="#" class="list-group-item list-group-item-action">
                            <i class="{{ insight.icon }} text-success mr-2"></i> {{ insight.text }}
                        </a>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Achievements Card -->
        <div class="card stat-card mb-4">
            <div class="card-body flex-column">
                <h5 class="card-title w-100 mb-3"><i class="fas fa-trophy text-warning"></i> Achievements</h5>
                <div class="list-group list-group-flush w-100">
                    {% for achievement in achievements %}
                        <div class="list-group-item d-flex align-items-center">
                             <i class="{{ achievement.icon }} achievement-icon mr-3"></i>
                            <div>
                                <strong>{{ achievement.name }}</strong>
                                <small class="d-block text-muted">{{ achievement.description }}</small>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript to render the charts and streak diagram -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Data passed from the Django view
        const categoryData = JSON.parse('{{ category_data_json|safe }}');
        const trendsData = JSON.parse('{{ trends_data_json|safe }}');
        const streakData = JSON.parse('{{ streak_data_json|safe }}');

        // 1. Trends Line Chart (Last 6 Months)
        const trendsCtx = document.getElementById('trendsChart').getContext('2d');
        new Chart(trendsCtx, {
            type: 'line',
            data: {
                labels: trendsData.labels,
                datasets: [{
                    label: 'kg CO₂e',
                    data: trendsData.data,
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    borderColor: '#28a745',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: false } },
                plugins: { legend: { display: false } }
            }
        });

        // 2. Category Breakdown Doughnut Chart
        const categoryCtx = document.getElementById('categoryChart').getContext('2d');
        new Chart(categoryCtx, {
            type: 'doughnut',
            data: {
                labels: categoryData.labels,
                datasets: [{
                    label: 'Footprint Breakdown',
                    data: categoryData.data,
                    backgroundColor: ['#28a745', '#17a2b8', '#ffc107', '#dc3545'],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
            }
        });
        
        // 3. Activity Streak Diagram
        const streakGrid = document.getElementById('streak-grid');
        const streakMonthsContainer = document.getElementById('streak-months');
        const totalActiveDaysSpan = document.getElementById('total-active-days');
        const maxStreakSpan = document.getElementById('max-streak');

        if (streakGrid) { // Check if the element exists
            totalActiveDaysSpan.textContent = streakData.total_active;
            maxStreakSpan.textContent = streakData.max_streak;

            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - 139); // Show last ~20 weeks

            const activeDays = new Set(streakData.active_days);
            let monthLabels = {};
            
            streakGrid.innerHTML = ''; 
            streakMonthsContainer.innerHTML = '';

            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dayElement = document.createElement('div');
                dayElement.classList.add('streak-day');
                
                const dateString = d.toISOString().split('T')[0];
                if (activeDays.has(dateString)) {
                    dayElement.classList.add('active');
                }
                
                dayElement.title = d.toDateString();
                streakGrid.appendChild(dayElement);

                const month = d.toLocaleString('default', { month: 'short' });
                if (!monthLabels[month]) {
                    monthLabels[month] = 0;
                }
                monthLabels[month]++;
            }

            let totalDays = 0;
            for (const count of Object.values(monthLabels)) { totalDays += count; }
            
            for (const [month, count] of Object.entries(monthLabels)) {
                 const monthEl = document.createElement('div');
                 monthEl.textContent = month;
                 monthEl.style.width = `${(count / totalDays) * 100}%`;
                 streakMonthsContainer.appendChild(monthEl);
            }
        }
    });
</script>

{% endblock content %}

