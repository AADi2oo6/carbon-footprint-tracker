{% extends 'tracker/base.html' %}

{% block content %}
<style>
    .page-container {
        max-width: 900px;
        margin: 2rem auto;
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }
    .activity-logger {
        /* max-width: 900px;
        margin: 2rem auto; */
        background: #fff;
        padding: 2rem;
        border-radius: 0.75rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    .activity-logger h1 {
        text-align: center;
        margin-bottom: 0.5rem;
        color: #333;
    }
    .activity-logger .lead {
        text-align: center;
        color: #6c757d;
        margin-bottom: 2.5rem;
    }
    .nav-tabs .nav-link {
        font-weight: 600;
        color: #6c757d; /* Softer text color for inactive tabs */
        border: none;
        border-radius: 0.5rem; /* Rounded corners for the tab button */
        padding: 0.75rem 1.5rem;
        margin: 0 5px;
        transition: all 0.3s ease-in-out; /* Smooth transition for hover and active states */
    }
    .nav-tabs .nav-link:hover {
        background-color: #e9f7ec; /* Light green background on hover */
        color: #218838; /* Darker green text on hover */
        transform: translateY(-2px); /* Slight lift effect on hover */
    }
    .nav-tabs .nav-link.active {
        background-color: #28a745; /* Main theme green for active tab */
        color: #ffffff; /* White text for active tab */
        box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3); /* Subtle shadow for depth */
    }
    .nav-tabs {
        border-bottom: 1px solid #dee2e6; /* A subtle line to separate tabs from content */
    }
    .tab-content {
        padding-top: 2rem;
    }
    .form-group label {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    .form-control, .custom-select {
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
        height: auto;
    }
    .btn-success {
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        border-radius: 0.5rem;
    }
    .input-group-text {
        background-color: #e9ecef;
        border-radius: 0.5rem 0 0 0.5rem;
    }
    .hardware-sync-card {
        background-color: #f8f9fa;
        border: 1px dashed #dee2e6;
        padding: 1.5rem;
        border-radius: 0.5rem;
        text-align: center;
    }
    .hardware-sync-card .sync-icon {
        font-size: 2.5rem;
        color: #28a745;
        margin-bottom: 1rem;
    }
    .hardware-sync-card .sync-status {
        font-weight: 600;
    }
    .hardware-sync-card .sync-status.connected {
        color: #28a745;
    }
    .hardware-sync-card .sync-status.disconnected {
        color: #dc3545;
    }
    .manual-entry-toggle {
        color: #007bff;
        cursor: pointer;
        text-decoration: none;
    }
    .manual-entry-toggle:hover {
        text-decoration: underline;
    }
    /* NEW: Styles for Smart Plug Integration */
    .smart-plug-interface {
        border: 1px solid #dee2e6;
        border-radius: 0.75rem;
        padding: 1.5rem;
    }
    .status-panel {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }
    .status-panel.searching { background-color: #fff3cd; color: #856404; }
    .status-panel.connected { background-color: #d4edda; color: #155724; }
    .status-panel.disconnected { background-color: #f8d7da; color: #721c24; }
    .status-icon { font-size: 1.5rem; margin-right: 1rem; }
    .status-text strong { display: block; }
    .data-display { text-align: center; margin: 2rem 0; }
    .data-display .data-label { color: #6c757d; font-weight: 500; }
    .data-display .data-value { font-size: 3rem; font-weight: 700; color: #28a745; line-height: 1.2; }
    .data-display .data-unit { font-weight: 500; color: #333; }
    .spinner-border-sm { width: 1rem; height: 1rem; border-width: .2em; }

    /* NEW: Styles for Activity History */
    .activity-history {
        margin-top: 3rem;
    }

    .activity-history h2 {
        text-align: center;
        margin-bottom: 2rem;
        color: #333;
    }
    .filter-bar {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .filter-bar .form-group {
        margin-bottom: 0;
    }
    .history-table {
        width: 100%;
        margin-top: 1rem;
        border-collapse: collapse;
    }
    .history-table th, .history-table td {
        padding: 0.9rem 1rem;
        text-align: left;
        vertical-align: middle;
        border-bottom: 1px solid #e9ecef;
    }
    .history-table thead th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #495057;
        border-top: 1px solid #dee2e6;
    }
    .history-table tbody tr:hover {
        background-color: #f1f3f5;
    }
    .history-table .category-icon {
        font-size: 1.2rem;
        width: 35px;
        height: 35px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        color: #fff;
    }
    .icon-travel { background-color: #3B82F6; }
    .icon-energy { background-color: #F59E0B; }
    .icon-food { background-color: #10B981; }
    .icon-purchases { background-color: #EF4444; }

    .history-table .actions a {
        color: #6c757d;
        margin: 0 5px;
        transition: color 0.2s;
    }
    .history-table .actions a:hover {
        color: #007bff;
    }
    .history-table .actions .delete-btn:hover {
        color: #dc3545;
    }
    .no-history {
        text-align: center;
        padding: 3rem;
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        margin-top: 1rem;
    }
    .no-history p {
        color: #6c757d;
        margin-bottom: 0;
    }
    .footprint-value {
        font-weight: 600;
        color: #343a40;
    }
    @media (max-width: 768px) {
        .filter-bar {
            flex-direction: column;
            align-items: stretch;
        }
        .filter-bar .form-group {
            width: 100%;
        }
    }
    /* NEW: Styles for Summary Cards and Budgets */
    .summary-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    .summary-card {
        background-color: #fff;
        padding: 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        text-align: center;
    }
    .summary-card .card-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }
    .summary-card .card-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: #28a745;
        line-height: 1.2;
    }
    .summary-card .card-unit {
        font-size: 0.8rem;
        color: #343a40;
    }
    .budget-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    .budget-card {
        background-color: #fff;
        padding: 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    .budget-card h5 {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
    }
    .budget-card .progress {
        height: 1.25rem;
        border-radius: 0.5rem;
        font-size: 0.8rem;
        font-weight: 600;
    }
    .budget-card .budget-details {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 0.5rem;
    }


</style>

<div class="page-container">
    <!-- NEW: Summary Section -->
    <div class="summary-section">
        <div class="summary-card">
            <div class="card-title">Today's Emissions</div>
            <div class="card-value">{{ emission_stats.today }}</div>
            <div class="card-unit">kg CO₂e</div>
        </div>
        <div class="summary-card">
            <div class="card-title">Yesterday's Emissions</div>
            <div class="card-value">{{ emission_stats.yesterday }}</div>
            <div class="card-unit">kg CO₂e</div>
        </div>
        <div class="summary-card">
            <div class="card-title">This Month</div>
            <div class="card-value">{{ emission_stats.this_month }}</div>
            <div class="card-unit">kg CO₂e</div>
        </div>
        <div class="summary-card">
            <div class="card-title">Last Month</div>
            <div class="card-value">{{ emission_stats.last_month }}</div>
            <div class="card-unit">kg CO₂e</div>
        </div>
    </div>

    <!-- NEW: Budget Section -->
    <div class="budget-section">
        <div class="budget-card">
            <h5>Daily Budget</h5>
            <div class="progress">
                <div class="progress-bar bg-success" role="progressbar" style="width: {{ daily_budget.percentage }}%;" aria-valuenow="{{ daily_budget.percentage }}" aria-valuemin="0" aria-valuemax="100">{{ daily_budget.percentage }}%</div>
            </div>
            <div class="budget-details">Used {{ daily_budget.used }} of {{ daily_budget.limit }} kg</div>
        </div>
        <div class="budget-card">
            <h5>Monthly Budget</h5>
            <div class="progress">
                <div class="progress-bar bg-success" role="progressbar" style="width: {{ monthly_budget.percentage }}%;" aria-valuenow="{{ monthly_budget.percentage }}" aria-valuemin="0" aria-valuemax="100">{{ monthly_budget.percentage }}%</div>
            </div>
            <div class="budget-details">Used {{ monthly_budget.used }} of {{ monthly_budget.limit }} kg</div>
        </div>
    </div>

    <div class="activity-logger">
        <h1>Log Your Activity</h1>
        <p class="lead">Add your daily activities to track your carbon footprint and see your impact.</p>

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs" id="activityTab" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="travel-tab" data-toggle="tab" href="#travel" role="tab" aria-controls="travel" aria-selected="true"><i class="fas fa-car mr-2"></i>Travel</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="energy-tab" data-toggle="tab" href="#energy" role="tab" aria-controls="energy" aria-selected="false"><i class="fas fa-bolt mr-2"></i>Energy</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="food-tab" data-toggle="tab" href="#food" role="tab" aria-controls="food" aria-selected="false"><i class="fas fa-utensils mr-2"></i>Food</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="purchases-tab" data-toggle="tab" href="#purchases" role="tab" aria-controls="purchases" aria-selected="false"><i class="fas fa-shopping-cart mr-2"></i>Purchases</a>
        </li>
    </ul>
        <!-- Tab Content -->
        <div class="tab-content" id="activityTabContent">
            <!-- Travel Tab -->
        <div class="tab-pane fade show active" id="travel" role="tabpanel" aria-labelledby="travel-tab">
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="category" value="transport">
                <div class="form-group">
                    <label for="transportMode">Mode of Transport</label>
                    <select class="custom-select" id="transportMode" name="transportMode" required>
                        <option selected>Choose...</option>
                        <option value="car-gasoline">Car (Gasoline)</option>
                        <option value="car-electric">Car (Electric)</option>
                        <option value="bus">Bus</option>
                        <option value="train">Train / Metro</option>
                        <option value="motorcycle">Motorcycle</option>
                        <option value="bicycle">Bicycle</option>
                        <option value="walking">Walking</option>
                        <option value="flight-short">Flight (Short-haul)</option>
                        <option value="flight-long">Flight (Long-haul)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="distance">Distance Traveled</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="distance" name="distance" placeholder="e.g., 25" min="0" step="any" required>
                        <div class="input-group-append">
                            <span class="input-group-text">km</span>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-success mt-3"><i class="fas fa-plus-circle mr-2"></i>Log Travel</button>
            </form>
        </div>

        <!-- Energy Tab -->
        <div class="tab-pane fade" id="energy" role="tabpanel" aria-labelledby="energy-tab">
            <div class="smart-plug-interface">
                <h5 class="mb-3">Smart Plug Integration</h5>

                <!-- Status Panels: Use JS to toggle visibility between these states -->

                <!-- 1. Disconnected State (Initial State) -->
                <div id="plug-disconnected" class="status-panel disconnected">
                    <div class="status-icon"><i class="fas fa-plug"></i></div>
                    <div class="status-text">
                        <strong>Smart Plug Disconnected</strong>
                        <span>Click below to search for your device.</span>
                    </div>
                </div>

                <!-- 2. Searching State -->
                <div id="plug-searching" class="status-panel searching" style="display: none;">
                    <div class="status-icon"><div class="spinner-border spinner-border-sm" role="status"></div></div>
                    <div class="status-text">
                        <strong>Searching for Smart Plug...</strong>
                        <span>Ensure your device is powered on and nearby.</span>
                    </div>
                </div>

                <!-- 3. Connected State -->
                <div id="plug-connected" class="status-panel connected" style="display: none;">
                    <div class="status-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="status-text">
                        <strong>Connected to Smart Plug</strong>
                        <span>Live data is being received.</span>
                    </div>
                </div>

                <!-- Data Display: Shows data from the plug -->
                <div class="data-display" style="display: none;">
                    <div class="data-label">Current Consumption</div>
                    <div class="data-value">1.25</div>
                    <div class="data-unit">kWh</div>
                </div>

                <!-- Action Buttons -->
                <button id="btn-find-plug" class="btn btn-primary"><i class="fas fa-search mr-2"></i>Find My Plug</button>
                <button id="btn-sync-now" class="btn btn-success" style="display: none;"><i class="fas fa-sync-alt mr-2"></i>Sync Now</button>
                <button id="btn-disconnect" class="btn btn-danger" style="display: none;"><i class="fas fa-times-circle mr-2"></i>Disconnect</button>
            </div>

            <div class="text-center mt-4">
                <a class="manual-entry-toggle" data-toggle="collapse" href="#manualEnergyEntry" role="button" aria-expanded="false" aria-controls="manualEnergyEntry">
                    Or, enter electricity data manually
                </a>
            </div>
            <div class="collapse mt-3" id="manualEnergyEntry">
                <form method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="category" value="energy">
                    <div class="form-group">
                        <label for="electricityUnits">Electricity Consumed</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="electricityUnits" name="electricityUnits" placeholder="e.g., 150" min="0" step="any" required>
                            <div class="input-group-append">
                                <span class="input-group-text">kWh</span>
                            </div>
                        </div>
                        <small class="form-text text-muted">Enter the units from your monthly electricity bill.</small>
                    </div>
                    <button type="submit" class="btn btn-success mt-3"><i class="fas fa-plus-circle mr-2"></i>Log Energy</button>
                </form>
            </div>
        </div>

        <!-- Food Tab -->
        <div class="tab-pane fade" id="food" role="tabpanel" aria-labelledby="food-tab">
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="category" value="food">
                <div class="form-row align-items-end">
                    <div class="form-group col-md-6">
                        <label for="mealType">Meal Type</label>
                        <select class="custom-select" id="mealType" name="mealType">
                            <option selected>Choose...</option>
                            <option value="breakfast">Breakfast</option>
                            <option value="lunch">Lunch</option>
                            <option value="dinner">Dinner</option>
                            <option value="snack">Snack</option>
                        </select>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="dietType">Primary Diet Type</label>
                        <select class="custom-select" id="dietType" name="dietType" required>
                            <option selected>Choose...</option>
                            <option value="red-meat">Red Meat (e.g., beef, lamb)</option>
                            <option value="white-meat">White Meat (e.g., chicken, pork)</option>
                            <option value="fish">Fish / Seafood</option>
                            <option value="vegetarian">Vegetarian (includes dairy/eggs)</option>
                            <option value="vegan">Vegan (plant-based)</option>
                            <option value="other">Other / Mixed</option>
                        </select>
                    </div>
                    <div class="form-group col-md-12">
                        <label for="foodQuantity">Quantity</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="foodQuantity" name="foodQuantity" placeholder="e.g., 1" value="1" min="1" required>
                            <div class="input-group-append">
                                <select class="custom-select" id="foodUnit" name="foodUnit" style="border-top-left-radius: 0; border-bottom-left-radius: 0;">
                                    <option value="serving" selected>serving(s)</option>
                                    <option value="item">item(s)</option>
                                    <option value="gram">grams</option>
                                    <option value="ounce">ounces</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <small class="form-text text-muted mb-3">Log the main component of your meal to get the best estimate of its carbon footprint.</small>
                <button type="submit" class="btn btn-success mt-3"><i class="fas fa-plus-circle mr-2"></i>Log Food</button>
            </form>
        </div>

        <!-- Purchases Tab -->
        <div class="tab-pane fade" id="purchases" role="tabpanel" aria-labelledby="purchases-tab">
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="category" value="consumption">
                <div class="form-group">
                    <label for="purchaseCategory">Purchase Category</label>
                    <select class="custom-select" id="purchaseCategory" name="purchaseCategory" required>
                        <option selected>Choose...</option>
                        <option value="clothing">Clothing & Apparel</option>
                        <option value="electronics">Electronics</option>
                        <option value="home-goods">Home Goods & Furniture</option>
                        <option value="services">Services (e.g., repairs, subscriptions)</option>
                        <option value="other">Other Goods</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="purchaseAmount">Amount Spent</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="purchaseAmount" name="purchaseAmount" placeholder="e.g., 50.00" min="0" step="0.01" required>
                        <div class="input-group-append">
                            <span class="input-group-text">INR</span>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-success mt-3"><i class="fas fa-plus-circle mr-2"></i>Log Purchase</button>
            </form>
        </div>
        </div>
    </div>

    <!-- Activity History Card -->
    <div class="activity-logger"> <!-- Re-using the .activity-logger class for card styling -->
        <div class="activity-history" style="margin-top: 0;">
            <h2>Activity History</h2>

            <!-- Filter Bar -->
            <form method="GET" action="{% url 'activity' %}">
                <div class="filter-bar form-row">
                    <div class="form-group col-md-5">
                        <label for="dateFilter" class="sr-only">Filter by Date</label>
                        <input type="date" class="form-control" id="dateFilter" name="dateFilter" value="{{ selected_date }}">
                    </div>
                    <div class="form-group col-md-5">
                        <label for="categoryFilter" class="sr-only">Filter by Category</label>
                        <select id="categoryFilter" name="categoryFilter" class="custom-select">
                            <option value="all" {% if selected_category == 'all' %}selected{% endif %}>All Categories</option>
                            <option value="transport" {% if selected_category == 'transport' %}selected{% endif %}>Transportation</option>
                            <option value="energy" {% if selected_category == 'energy' %}selected{% endif %}>Energy</option>
                            <option value="food" {% if selected_category == 'food' %}selected{% endif %}>Food</option>
                            <option value="consumption" {% if selected_category == 'consumption' %}selected{% endif %}>Purchases</option>
                            <option value="waste" {% if selected_category == 'waste' %}selected{% endif %}>Waste</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-outline-secondary"><i class="fas fa-filter mr-2"></i>Apply Filter</button>
                </div>
            </form>

            <!-- History Table -->
            <div class="table-responsive">
                <table class="history-table">
                <thead>
                    <tr>
                        <th scope="col">Category</th>
                        <th scope="col">Description</th>
                        <th scope="col">Date</th>
                        <th scope="col">Footprint (kg CO₂e)</th>
                        <th scope="col">Actions</th>
                    </tr>
                </thead>
                <tbody>
                <tbody id="activity-history-body">
                    {% for activity in activities %}
                    <tr id="activity-row-{{ activity.id }}">
                        <td>
                            <span class="category-icon {% if activity.category == 'transport' %}icon-travel{% elif activity.category == 'consumption' %}icon-purchases{% else %}icon-{{ activity.category }}{% endif %}" title="{{ activity.get_category_display }}">
                                {% if activity.category == 'transport' %}<i class="fas fa-car"></i>
                                {% elif activity.category == 'energy' %}<i class="fas fa-bolt"></i>
                                {% elif activity.category == 'food' %}<i class="fas fa-utensils"></i>
                                {% elif activity.category == 'consumption' %}<i class="fas fa-shopping-cart"></i>
                                {% elif activity.category == 'waste' %}<i class="fas fa-recycle"></i>
                                {% endif %}
                            </span>
                        </td>
                        <td data-description="{{ activity.description }}">{{ activity.description }}</td>
                        <td>{{ activity.timestamp|date:"Y-m-d" }}</td>
                        <td class="footprint-value" data-footprint="{{ activity.emission.co2_equivalent_kg }}">{{ activity.emission.co2_equivalent_kg }}</td>
                        <td class="actions">
                            <a href="#" class="edit-btn" title="Edit" data-toggle="modal" data-target="#editActivityModal" data-id="{{ activity.id }}" data-description="{{ activity.description }}" data-footprint="{{ activity.emission.co2_equivalent_kg }}">
                                <i class="fas fa-pencil-alt"></i>
                            </a>
                            <a href="#" class="delete-btn" title="Delete" data-id="{{ activity.id }}">
                                <i class="fas fa-trash-alt"></i>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5">
                            <div class="no-history">
                                <p>No activities logged for this day. Use the form above to add one!</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            </div>
        </div>
    </div>
</div>

<!-- Edit Activity Modal -->
<div class="modal fade" id="editActivityModal" tabindex="-1" role="dialog" aria-labelledby="editActivityModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editActivityModalLabel">Edit Activity</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form id="editActivityForm" method="POST">
        {% csrf_token %}
        <input type="hidden" name="action" value="update">
        <input type="hidden" id="editActivityId" name="activity_id">
        <!-- Pass current filters to the view on update -->
        <input type="hidden" name="dateFilter" value="{{ selected_date }}">
        <input type="hidden" name="categoryFilter" value="{{ selected_category }}">
        <div class="modal-body">
            <div class="form-group">
                <label for="editDescription">Description</label>
                <input type="text" class="form-control" id="editDescription" name="description" required>
            </div>
            <div class="form-group">
                <label for="editFootprint">Footprint (kg CO₂e)</label>
                <input type="number" step="any" class="form-control" id="editFootprint" name="footprint" required>
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-success">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Hidden form for deletion -->
<form id="deleteActivityForm" method="POST" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="action" value="delete">
    <input type="hidden" id="deleteActivityId" name="activity_id">
    <!-- Pass current filters to the view on delete -->
    <input type="hidden" name="dateFilter" value="{{ selected_date }}">
    <input type="hidden" name="categoryFilter" value="{{ selected_category }}">
</form>

<script>
// --- NEW: AJAX Form Submission ---
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('.activity-form');

    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault(); // Prevent the default page reload

            const formData = new FormData(form);
            const submitButton = form.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Logging...`;
            submitButton.disabled = true;

            fetch("{% url 'activity' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    'X-Requested-With': 'XMLHttpRequest' // Important for the view to identify AJAX
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Add the new activity to the history table
                    addActivityRow(data.activity);
                    // Reset the form fields
                    form.reset();
                    // Show a success message (optional, can be a toast notification)
                    alert('Activity logged successfully!');
                } else {
                    // Show an error message
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An unexpected error occurred. Please try again.');
            })
            .finally(() => {
                // Restore the submit button
                submitButton.innerHTML = originalButtonText;
                submitButton.disabled = false;
            });
        });
    });

    // --- NEW: Toast Notification Function ---
    function showToast(title, message, type = 'success') {
        const toastElement = document.getElementById('activityToast');
        const toastTitle = document.getElementById('toast-title');
        const toastBody = document.getElementById('toast-body');
        const toastHeader = toastElement.querySelector('.toast-header');

        toastTitle.textContent = title;
        toastBody.textContent = message;
        toastHeader.classList.toggle('bg-success', type === 'success');
        toastHeader.classList.toggle('text-white', type === 'success');
        toastHeader.classList.toggle('bg-danger', type === 'error');
        toastHeader.classList.toggle('text-white', type === 'error');

        $('.toast').toast('show');
    }

    function addActivityRow(activity) {
        const historyTableBody = document.getElementById('activity-history-body');
        const noHistoryRow = historyTableBody.querySelector('.no-history');
        if (noHistoryRow) {
            noHistoryRow.closest('tr').remove(); // Remove the "No activities" message
        }

        const newRow = document.createElement('tr');
        newRow.id = `activity-row-${activity.id}`;

        // Determine icon and color class based on category
        let iconClass, colorClass;
        switch(activity.category) {
            case 'transport':
                iconClass = 'fas fa-car';
                colorClass = 'icon-travel';
                break;
            case 'energy':
                iconClass = 'fas fa-bolt';
                colorClass = 'icon-energy';
                break;
            case 'food':
                iconClass = 'fas fa-utensils';
                colorClass = 'icon-food';
                break;
            case 'consumption':
                iconClass = 'fas fa-shopping-cart';
                colorClass = 'icon-purchases';
                break;
            default:
                iconClass = 'fas fa-recycle';
                colorClass = 'icon-waste'; // A default
        }

        newRow.innerHTML = `
            <td>
                <span class="category-icon ${colorClass}" title="${activity.category_display}">
                    <i class="${iconClass}"></i>
                </span>
            </td>
            <td data-description="${activity.description}">${activity.description}</td>
            <td>${activity.date}</td>
            <td class="footprint-value" data-footprint="${activity.footprint}">${activity.footprint}</td>
            <td class="actions">
                <a href="#" class="edit-btn" title="Edit" data-toggle="modal" data-target="#editActivityModal" data-id="${activity.id}" data-description="${activity.description}" data-footprint="${activity.footprint}">
                    <i class="fas fa-pencil-alt"></i>
                </a>
                <a href="#" class="delete-btn" title="Delete" data-id="${activity.id}">
                    <i class="fas fa-trash-alt"></i>
                </a>
            </td>
        `;

        historyTableBody.prepend(newRow); // Add the new row to the top of the table
    }
});

// --- Existing Edit/Delete Logic ---
document.addEventListener('DOMContentLoaded', function() {
    const historyBody = document.getElementById('activity-history-body');

    // Handle Edit button click
    $('.edit-btn').on('click', function() {
        const activityId = $(this).data('id');
        const row = $('#activity-row-' + activityId);
        const description = $(this).data('description');
        const footprint = $(this).data('footprint');

        $('#editActivityId').val(activityId);
        $('#editDescription').val(description);
        $('#editFootprint').val(footprint);
    });

    // --- NEW: AJAX for Edit Form Submission ---
    $('#editActivityForm').on('submit', function(e) {
        e.preventDefault();
        const form = $(this);
        const formData = new FormData(this);
        const submitButton = form.find('button[type="submit"]');
        const originalButtonText = submitButton.html();

        submitButton.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...').prop('disabled', true);

        fetch("{% url 'activity' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the row in the table
                const row = $(`#activity-row-${data.activity.id}`);
                row.find('td[data-description]').text(data.activity.description);
                row.find('.footprint-value').text(data.activity.footprint);
                // Also update the data attributes for the next edit
                row.find('.edit-btn').data('description', data.activity.description).attr('data-description', data.activity.description);
                row.find('.edit-btn').data('footprint', data.activity.footprint).attr('data-footprint', data.activity.footprint);

                $('#editActivityModal').modal('hide');
                alert('Activity updated successfully!');
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An unexpected error occurred.');
        })
        .finally(() => {
            submitButton.html(originalButtonText).prop('disabled', false);
        });
    });

    // Handle Delete button click
    // Use event delegation for dynamically added rows
    $(historyBody).on('click', '.delete-btn', function(e) {
        e.preventDefault();
        if (confirm('Are you sure you want to delete this activity?')) {
            const activityId = $(this).data('id');
            const csrfToken = $('#deleteActivityForm [name=csrfmiddlewaretoken]').val();

            fetch("{% url 'activity' %}", {
                method: 'POST',
                body: new URLSearchParams({
                    'action': 'delete',
                    'activity_id': activityId,
                    'csrfmiddlewaretoken': csrfToken
                }),
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    $(`#activity-row-${data.deleted_id}`).fadeOut(300, function() { $(this).remove(); });
                } else {
                    alert('Error: ' + data.error);
                }
            });
        }
    });
});
</script>

{% endblock %}
